# Spring Security OAuth2 Authorization Redirect WEB PKCE

+ https://www.analyticsvidhya.com/blog/2022/06/spring-security-oauth2-with-keycloak-pkce-authorization-code-flow/
+ https://www.youtube.com/watch?v=NvNnE67wMnQ
+ https://ordina-jworks.github.io/security/2019/08/22/Securing-Web-Applications-With-Keycloak.html

## Banckend
![img.png](img.png)

PKCE enabled on Keycloak


## Frontend SPA

[Angular Frontend](./src/front/README.md)

`src/front/src/app/auth.config.ts` contains all PKCE setup

### Access

[http://localhost:4200 ](http://localhost:4200)


### Flow

GET -> http://localhost:8080/realms/api-authorization/protocol/openid-connect/auth?response_type=code&client_id=angular-authorization-redirect-web-pkce&state=M3IyTzl5UXoyT0NIVEs2UWctaVViOHpmcmN2b1VkV1BkRkFRRTR5QVFZMmZs&redirect_uri=http%3A%2F%2Flocalhost%3A4200&scope=openid%20profile%20email%20offline_access&code_challenge=v7ZiSJDQ4XtwbsObTMIAH515a9HtWfLZ46mrrIj2lkg&code_challenge_method=S256&nonce=M3IyTzl5UXoyT0NIVEs2UWctaVViOHpmcmN2b1VkV1BkRkFRRTR5QVFZMmZs


```text
Request URL: 
http://localhost:8080/realms/api-authorization/protocol/openid-connect/auth?
response_type=code&
client_id=angular-authorization-redirect-web-pkce&
state=M3IyTzl5UXoyT0NIVEs2UWctaVViOHpmcmN2b1VkV1BkRkFRRTR5QVFZMmZs&
redirect_uri=http%3A%2F%2Flocalhost%3A4200&
scope=openid%20profile%20email%20offline_access&
code_challenge=v7ZiSJDQ4XtwbsObTMIAH515a9HtWfLZ46mrrIj2lkg&
code_challenge_method=S256&nonce=M3IyTzl5UXoyT0NIVEs2UWctaVViOHpmcmN2b1VkV1BkRkFRRTR5QVFZMmZs
```

POST -> LOGIN

GET -> http://localhost:4200/?state=M3IyTzl5UXoyT0NIVEs2UWctaVViOHpmcmN2b1VkV1BkRkFRRTR5QVFZMmZs&session_state=8725c8fd-8d7d-4f20-80c7-c98caa20ae5d&code=7b9db1c3-6ae2-4d99-ad79-b5d0fed48fd4.8725c8fd-8d7d-4f20-80c7-c98caa20ae5d.0ef39a2f-0f08-4b7f-9182-a8fe4b3b91b0

GET -> http://localhost:8080/realms/api-authorization/.well-known/openid-configuration
GET -> http://localhost:8080/realms/api-authorization/protocol/openid-connect/certs

POST -> http://localhost:8080/realms/api-authorization/protocol/openid-connect/token
grant_type: authorization_code
code: 7b9db1c3-6ae2-4d99-ad79-b5d0fed48fd4.8725c8fd-8d7d-4f20-80c7-c98caa20ae5d.0ef39a2f-0f08-4b7f-9182-a8fe4b3b91b0
redirect_uri: http://localhost:4200
code_verifier: STd3TGcwSHREOEhzU2t2andSalRObmdEN0VWNG01TnVvRUYxRGNjckMueFdy
client_id: angular-authorization-redirect-web-pkce

```
{
"access_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJKOUptMFZ0ZU1OZHoyNkh6bklJX2FPWjRCbTR1NVN1WFBjS1JoOW9HUVJvIn0.eyJleHAiOjE2NTgyMzI3MjYsImlhdCI6MTY1ODIzMjQyNiwiYXV0aF90aW1lIjoxNjU4MjMyNDI1LCJqdGkiOiJkZDg5MWNjMS1lYjVmLTRiZmUtYjE1OC02M2ViNTY5NzU4ZDciLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL2FwaS1hdXRob3JpemF0aW9uIiwic3ViIjoiZTI3YmFhYzUtMTg1MS00ZGI1LWEzNTEtZTEwZWU4ZGFmOTk3IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYW5ndWxhci1hdXRob3JpemF0aW9uLXJlZGlyZWN0LXdlYi1wa2NlIiwibm9uY2UiOiJNM0l5VHpsNVVYb3lUME5JVkVzMlVXY3RhVlZpT0hwbWNtTjJiMVZrVjFCa1JrRlJSVFI1UVZGWk1tWnMiLCJzZXNzaW9uX3N0YXRlIjoiODcyNWM4ZmQtOGQ3ZC00ZjIwLTgwYzctYzk4Y2FhMjBhZTVkIiwiYWNyIjoiMSIsImFsbG93ZWQtb3JpZ2lucyI6WyIqIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtYXBpLWF1dGhvcml6YXRpb24iLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCBvZmZsaW5lX2FjY2VzcyIsInNpZCI6Ijg3MjVjOGZkLThkN2QtNGYyMC04MGM3LWM5OGNhYTIwYWU1ZCIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJ1c2VyMSJ9.cqs7e6_biN68aWJgv58Wf2yRB8T2Y_pKJF3-TkP8QupYx8Ym30X4LSKgEQ-R2HmaqTDm43eUiQsNhwdqnIDio6vE6zWqHm-GtTNe2DHSYEfX62aaWEmbGEnvYKYM2BgS18WZVTMzgGml-uQ8oGJvU8RKE1SQk18OKHB94-cxmJrJIGlRcHTczfbY14ErXz--2mLpkJbDwGR6VKI5Hs9ag8NU4NJUu2VmqrY-g1FS_PqXKwVcBjCY87Puyw9Bt5FMAbKcwBRmaiWNmFewjV5gZev2fpVW6I3uoMzaKVUaKK4l7lV_JxOvkh7OZTox9qj5gCT4egMY9hBPWCzx3uzFPw",
"expires_in": 300,
"refresh_expires_in": 0,
"refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJhODBhZjNmZS05ZWM2LTQwM2MtOThmYi1iZDZjYWY1MDZkNTYifQ.eyJpYXQiOjE2NTgyMzI0MjYsImp0aSI6ImRjZDM0ZTk0LTRlYTItNGY5Mi05ZDYzLTk2NDUwM2FiYzkyOCIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC9yZWFsbXMvYXBpLWF1dGhvcml6YXRpb24iLCJhdWQiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL2FwaS1hdXRob3JpemF0aW9uIiwic3ViIjoiZTI3YmFhYzUtMTg1MS00ZGI1LWEzNTEtZTEwZWU4ZGFmOTk3IiwidHlwIjoiT2ZmbGluZSIsImF6cCI6ImFuZ3VsYXItYXV0aG9yaXphdGlvbi1yZWRpcmVjdC13ZWItcGtjZSIsIm5vbmNlIjoiTTNJeVR6bDVVWG95VDBOSVZFczJVV2N0YVZWaU9IcG1jbU4yYjFWa1YxQmtSa0ZSUlRSNVFWRlpNbVpzIiwic2Vzc2lvbl9zdGF0ZSI6Ijg3MjVjOGZkLThkN2QtNGYyMC04MGM3LWM5OGNhYTIwYWU1ZCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwgb2ZmbGluZV9hY2Nlc3MiLCJzaWQiOiI4NzI1YzhmZC04ZDdkLTRmMjAtODBjNy1jOThjYWEyMGFlNWQifQ.BEw1SwN8vnWPd8vvQs5ozOosLI3cj-z08yaBorhvAds",
"token_type": "Bearer",
"id_token": "eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJKOUptMFZ0ZU1OZHoyNkh6bklJX2FPWjRCbTR1NVN1WFBjS1JoOW9HUVJvIn0.eyJleHAiOjE2NTgyMzI3MjYsImlhdCI6MTY1ODIzMjQyNiwiYXV0aF90aW1lIjoxNjU4MjMyNDI1LCJqdGkiOiJiYmMyNWE5YS02NGMwLTRhZDItYWRhZC0wYTg3ZWFjNDBiODMiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL2FwaS1hdXRob3JpemF0aW9uIiwiYXVkIjoiYW5ndWxhci1hdXRob3JpemF0aW9uLXJlZGlyZWN0LXdlYi1wa2NlIiwic3ViIjoiZTI3YmFhYzUtMTg1MS00ZGI1LWEzNTEtZTEwZWU4ZGFmOTk3IiwidHlwIjoiSUQiLCJhenAiOiJhbmd1bGFyLWF1dGhvcml6YXRpb24tcmVkaXJlY3Qtd2ViLXBrY2UiLCJub25jZSI6Ik0zSXlUemw1VVhveVQwTklWRXMyVVdjdGFWVmlPSHBtY21OMmIxVmtWMUJrUmtGUlJUUjVRVkZaTW1acyIsInNlc3Npb25fc3RhdGUiOiI4NzI1YzhmZC04ZDdkLTRmMjAtODBjNy1jOThjYWEyMGFlNWQiLCJhdF9oYXNoIjoieXg2VzhqOENTY04yU0JyTVFvU0hsQSIsImFjciI6IjEiLCJzaWQiOiI4NzI1YzhmZC04ZDdkLTRmMjAtODBjNy1jOThjYWEyMGFlNWQiLCJlbWFpbF92ZXJpZmllZCI6dHJ1ZSwicHJlZmVycmVkX3VzZXJuYW1lIjoidXNlcjEifQ.XiDK7PZzK4PYdEuRfOphe2LSYijmNs_xvq0Hucll_WQ2X062AaUi_FuHAf3Rc1bnYsA3yiVHVKWaeAiFLxRoDWVKQZ5sZXwdD63xX-SE0LLrKVa4j-vRpTsi0gVBg-mqa0C6QVuvhK-VbUwjUqT0wyosg2Rc8VlYKXOGHjdSMcha3IDsVwlxVanG0xuVcFOxRReYw1SxPfSiSr5h7sAt2gNTVPWo4IqrQLde8kp_jB8AqJHzAFHLfPAq9PCC7ao5l7TKDnOxFY0RKx8rf9-afMuwbeHLFlHg8hvVHQ0VriSyULqbb3EcpUKGsdCMK-iHVlX7AAdCOYFUoS4W07JubA",
"not-before-policy": 1658162974,
"session_state": "8725c8fd-8d7d-4f20-80c7-c98caa20ae5d",
"scope": "openid profile email offline_access"
}
```

Cors preflight
```text
Request URL: http://localhost:8086/api
Request Method: OPTIONS
Status Code: 200
Remote Address: 127.0.0.1:8086
Referrer Policy: strict-origin-when-cross-origin
```

Request

```text
Request URL: http://localhost:8086/api
Request Method: GET
Status Code: 200
Remote Address: 127.0.0.1:8086
Referrer Policy: strict-origin-when-cross-origin
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJKOUptMFZ0ZU1OZHoyNkh6bklJX2FPWjRCbTR1NVN1WFBjS1JoOW9HUVJvIn0.eyJleHAiOjE2NTgyMzI3MjYsImlhdCI6MTY1ODIzMjQyNiwiYXV0aF90aW1lIjoxNjU4MjMyNDI1LCJqdGkiOiJkZDg5MWNjMS1lYjVmLTRiZmUtYjE1OC02M2ViNTY5NzU4ZDciLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL2FwaS1hdXRob3JpemF0aW9uIiwic3ViIjoiZTI3YmFhYzUtMTg1MS00ZGI1LWEzNTEtZTEwZWU4ZGFmOTk3IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoiYW5ndWxhci1hdXRob3JpemF0aW9uLXJlZGlyZWN0LXdlYi1wa2NlIiwibm9uY2UiOiJNM0l5VHpsNVVYb3lUME5JVkVzMlVXY3RhVlZpT0hwbWNtTjJiMVZrVjFCa1JrRlJSVFI1UVZGWk1tWnMiLCJzZXNzaW9uX3N0YXRlIjoiODcyNWM4ZmQtOGQ3ZC00ZjIwLTgwYzctYzk4Y2FhMjBhZTVkIiwiYWNyIjoiMSIsImFsbG93ZWQtb3JpZ2lucyI6WyIqIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJvZmZsaW5lX2FjY2VzcyIsImRlZmF1bHQtcm9sZXMtYXBpLWF1dGhvcml6YXRpb24iLCJ1bWFfYXV0aG9yaXphdGlvbiJdfSwic2NvcGUiOiJvcGVuaWQgcHJvZmlsZSBlbWFpbCBvZmZsaW5lX2FjY2VzcyIsInNpZCI6Ijg3MjVjOGZkLThkN2QtNGYyMC04MGM3LWM5OGNhYTIwYWU1ZCIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJ1c2VyMSJ9.cqs7e6_biN68aWJgv58Wf2yRB8T2Y_pKJF3-TkP8QupYx8Ym30X4LSKgEQ-R2HmaqTDm43eUiQsNhwdqnIDio6vE6zWqHm-GtTNe2DHSYEfX62aaWEmbGEnvYKYM2BgS18WZVTMzgGml-uQ8oGJvU8RKE1SQk18OKHB94-cxmJrJIGlRcHTczfbY14ErXz--2mLpkJbDwGR6VKI5Hs9ag8NU4NJUu2VmqrY-g1FS_PqXKwVcBjCY87Puyw9Bt5FMAbKcwBRmaiWNmFewjV5gZev2fpVW6I3uoMzaKVUaKK4l7lV_JxOvkh7OZTox9qj5gCT4egMY9hBPWCzx3uzFPw
```
